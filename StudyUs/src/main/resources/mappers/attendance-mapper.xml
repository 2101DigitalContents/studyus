<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="attendanceMapper">

	<resultMap type="Attendance" id="attendanceResultMap">
		<id property="attendanceNo" column="AT_NO"></id>
		<result property="rNum" column="RNUM"></result>
		<result property="memberNo" column="MB_NO"></result>
		<result property="studyNo" column="ST_NO"></result>
		<result property="meetingNo" column="ME_NO"></result>
		<result property="atInsertDate" column="AT_INSERTDATE"></result> 
	</resultMap>
	
<!-- 	<select id="printAllAtt" parameterType="_int" resultType="attendanceResultMap">
		SELECT ROW_NUMBER() OVER(ORDER BY A.AT_INSERTDATE DESC) AS RNUM,
		A.AT_NO, A.MB_NO, ST_NO, M.MB_NICKNAME, 
		A.AT_INSERTDATE, A.ME_NO, T.ME_REQUIRED_ATTENDANCE 
		FROM ATTENDANCE A
		JOIN MEETING T USING (ST_NO)
		JOIN MEMBER M ON A.MB_NO = M.MB_NO
		WHERE ST_NO = #{studyNo}
	</select> -->
	
	<insert id="insertAttendance" parameterType="Attendance">
		INSERT INTO ATTENDANCE VALUES (SEQ_ATTENDANCE.NEXTVAL,
										#{memberNo},
										#{studyNo},
										#{meetingNo},
										SYSDATE)
	</insert>
	
	<select id="checkTodayAttendedAlready" parameterType="Attendance" resultType="int">
		SELECT COUNT(*) FROM ATTENDANCE WHERE ME_NO = #{meetingNo} AND MB_NO = #{memberNo} AND TRUNC(SYSDATE) &gt;= AT_INSERTDATE
	</select>
	
	<!-- 해당 스터디가 현재 출석체크 시간인지 확인합니다. -->
	<select id="checkAttendanceTime" parameterType="Map" resultType="int">
		SELECT COUNT(*) FROM STUDY WHERE ST_NO = #{studyNo} AND #{now} BETWEEN ST_START AND ST_END
	</select>
	
	<!-- studyNo에 대해 memberNo가 오늘 출석체크한 기록이 몇 개인지 확인합니다. -->
	<select id="checkAttendanceToday" parameterType="Attendance" resultType="int">
		SELECT COUNT(*) FROM ATTENDANCE WHERE ST_NO = #{studyNo} AND MB_NO = #{memberNo} AND TRUNC(SYSDATE) &lt;= AT_INSERTDATE
	</select>
	
</mapper>
